# Week 4: architecture rework planning

# Step 1

- зарисовал “нулевую” систему в привычной нотации (сервисы + коммуникации)

Система из нулевой домашки

![hw4_initial_arch_c4.jpg](./resources/hw4_initial_arch_c4.jpg)

Система из нулевой домашки в привычной нотации
![hw4_initial_system_cm.jpg](./resources/hw4_initial_system_cm.jpg)

# Step 2

- добавил неочевидные коммуникации в “нулевую систему”
- убрал аспектные / инфрастуктурные сервисы, не учитываем их при анализе
- считаю инстабилити и нахожу отмечаю самые проблемные места

![hw4_initial_system_tailored.jpg](./resources/hw4_initial_system_tailored.jpg)

# Step 3

- нахожу, где в моей AS IS находятся контексты TO BE

| TO BE контекст | Поддомен | где находится в AS IS | Статус |
| --- | --- | --- | --- |
| прием и выполнение услуги | generic | order placement и order execution | не совпало |
| подготовка расходников для услуги | supporting | order execution | не совпало |
| система метчинга воркера на услугу | core | worker matching | совпало |
| прием заявок и тестирование кандидатов | core | worker onboarding | совпало |
| расчет и оплата услуг клиентом | generic | accounting and billing | не совпало |
| расчет и выплата зарплаты | generic | accounting and billing | не совпало |
| система ставок для менеджеров | supporting | нет | не совпало |

Анализирую сравнение, получается список того, что необходимо поменять / добавить:

- “order placement” и “order execution” нужно смержить в один сервис (в котором находятся два контекста “прием и выполнение услуги” и “подготовка расходников для услуги”) - **надо менять**
- “система метчинга воркера на услугу” матчится 1 к 1 с “worker matching” - **не надо менять**
- “прием заявок и тестирование кандидатов” матчится 1 к 1 с “worker onboarding” - **не надо менять**
- “accounting and billing” должен распасться на 2 сервиса: “расчет и оплата услуг клиентом” и “расчет и выплата зарплаты” - **надо менять**
- “система ставок для менеджеров” отсутствует - **надо добавить**

![hw4_asis_tobe.jpg](./resources/hw4_asis_tobe.jpg)

Мы находимся в условиях отсутствия опыта (в моих кругах это более частый случай), поэтому тактика будет такой:

- мигрируем систему от простых элементов к сложным
- ~~если приоритеты позволяют, начинаем с отсутствующих элементов~~ в нашем случае распределенная инфрастуктура уже есть и используется в проде, поэтому не актуально
- ~~начать с generic, закончить core~~ в нашем случае core поддомены совпали, поэтому core мигрировать не требуется
- начать с меньших элементов, закончить большими

Составляю список изменений:

- добавление нового сервиса “система ставок для менеджеров”
- добавление нового сервиса с двумя контекстами “прием и выполнение услуги” и “подготовка расходников для услуги” вместо двух существующих сервисов “order placement” и “order execution”
- добавление двух новых сервисов для денег вместо текущего одного “accounting and billing”

# Step 4.1 adding new service “management betting”

Предположим, что приоритеты нам позволяют начать наш проект перехода с добавления нового сервиса.

Имплементируем сервис, подключаем его к нашей инфраструктуре доменных событий по Task и Client сущностям.

Этим слегка повышаем instability “order execution service” сервиса с 0.5 на 0.6, но считаем это допустимым, т.к. это временные эффект.

![hw4_migration_1.jpg](./resources/hw4_migration_1.jpg)

# Step 4.2 adding a new service with the two contexts "service execution" and "service preparation"

1. добавляем логику сервиса “order placement service” в сервис “order execution service”, а после убираем “order placement service”. получаем вместо двух сервисов с 0.6 и 0.6 instability один на 0.83 instability. Делаем это через CDC.
2. делаем рефакторинг внутри сервиса на модульный монолит, извлекаем логику подготовки расходников в отдельный модель и получаем два контекста: “прием и выполнение услуги” (0.83 instability) и “подготовка расходников для услуги” (0 instability)

![hw4_migration_2.jpg](./resources/hw4_migration_2.jpg)

# Step 4.3 adding two new service for money-related processes instead of a single "accounting and billing"

1. отказываемся от стриминга воркеров из “worker onboarding service” в “accounting and billing service”, т.к. эта избытычно. воркеры в биллинг должны попадать только из одного места и в таргет решении это будет “прием и выполнение услуги”. “Вспоминаем” про то, что нам нужно считать скидку (про эту фичу просто забыли), добавляем это как синхронную связь (как в таргет решении). Меняем instability с 0 на 0.25.
2. Распиливаем монолитный биллинг на два сервиса, в каждом по контексту “расчет и оплата услуг клиентом” и “расчет и выплата зарплаты” с помощью CDC.
3. После окончании имплементации двух новых сервисов включаем в систему новые, отключаем старые. Оставляем старый сервис функционировать, чтобы вернуться на него в случае роллбека. Верифицируем корректность работы новых сервисов с помощью сравнения данных из старого.

![hw4_migration_3.jpg](./resources/hw4_migration_3.jpg)

# Result

![hw4_result.jpg](./resources/hw4_result.jpg)